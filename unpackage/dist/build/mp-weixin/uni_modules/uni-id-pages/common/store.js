"use strict";const e=require("../../../common/vendor.js"),n=require("../config.js"),t=e.Es.importObject("uni-id-co"),s=e.Es.database().collection("uni-id-users");let i=e.index.getStorageSync("uni-id-pages-userInfo")||{},o=e.Es.getCurrentUserInfo().tokenExpired-Date.now();o<=0&&(i={});const r={userInfo:i,hasLogin:0!=Object.keys(i).length&&o>0},a={async updateUserInfo(n=!1){if(n)s.where("_id==$env.uid").update(n).then((t=>{t.result.updated?(e.index.showToast({title:"更新成功",icon:"none",duration:3e3}),this.setUserInfo(n)):e.index.showToast({title:"没有改变",icon:"none",duration:3e3})}));else try{let e=await s.where("'_id' == $cloudEnv_uid").field("mobile,nickname,username,email,avatar_file,register_date").get();this.setUserInfo(e.result.data[0])}catch(t){this.setUserInfo({},{cover:!0}),console.error(t.message,t.errCode)}},async setUserInfo(n,{cover:t}={cover:!1}){let s=t?n:Object.assign(d.userInfo,n);return d.userInfo=Object.assign({},s),d.hasLogin=0!=Object.keys(d.userInfo).length,e.index.setStorage({key:"uni-id-pages-userInfo",data:d.userInfo}),n},async logout(){if(e.Es.getCurrentUserInfo().tokenExpired>Date.now())try{await t.logout()}catch(n){console.error(n)}e.index.removeStorageSync("uni_id_token"),e.index.setStorageSync("uni_id_token_expired",0),e.index.switchTab({url:"/pages/self/self"}),e.index.$emit("uni-id-pages-logout"),this.setUserInfo({},{cover:!0})},loginBack(n={}){const{uniIdRedirectUrl:t=""}=n;let s=0,i=getCurrentPages();if(i.forEach(((e,n)=>{"login"==i[i.length-n-1].route.split("/")[3]&&s++})),t)return e.index.reLaunch({url:t});if(s){const n=e.pageJson.pages[0];return e.index.reLaunch({url:`/${n.path}`})}e.index.navigateBack({delta:s})},loginSuccess(t={}){const{showToast:s=!0,toastText:i="登录成功",autoBack:o=!0,uniIdRedirectUrl:r="",passwordConfirmed:a}=t;if(s&&e.index.showToast({title:i,icon:"none",duration:3e3}),this.updateUserInfo(),e.index.$emit("uni-id-pages-login-success"),n.config.setPasswordAfterLogin&&!a)return e.index.redirectTo({url:r?`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${r}&loginType=${t.loginType}`:`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${t.loginType}`,fail:e=>{console.log(e)}});o&&this.loginBack(r)}},d=e.reactive(r);exports.mutations=a,exports.store=d;
