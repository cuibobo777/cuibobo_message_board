"use strict";const e=require("../../../../common/vendor.js"),i=require("../../config.js"),t=require("../../common/store.js"),n={computed:{agreements(){if(!i.config.agreements)return[];let{serviceUrl:e,privacyUrl:t}=i.config.agreements;return[{url:e,title:"用户服务协议"},{url:t,title:"隐私政策条款"}]},agree:{get(){return this.getParentComponent().agree},set(e){return this.getParentComponent().agree=e}}},data:()=>({servicesList:[{id:"username",text:"账号登录",logo:"/uni_modules/uni-id-pages/static/login/uni-fab-login/user.png",path:"/uni_modules/uni-id-pages/pages/login/login-withpwd"},{id:"smsCode",text:"短信验证码",logo:"/uni_modules/uni-id-pages/static/login/uni-fab-login/sms.png",path:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd?type=smsCode"},{id:"weixin",text:"微信登录",logo:"/uni_modules/uni-id-pages/static/login/uni-fab-login/weixin.png"}],univerifyStyle:{fullScreen:!0,backgroundColor:"#ffffff",buttons:{iconWidth:"45px",list:[]},privacyTerms:{defaultCheckBoxState:!1,textColor:"#BBBBBB",termsColor:"#5496E3",prefix:"我已阅读并同意",suffix:"并使用本机号码登录",privacyItems:[]}}}),watch:{agree(e){this.univerifyStyle.privacyTerms.defaultCheckBoxState=e}},async created(){let e=this.servicesList,t=i.config.loginTypes;e=e.filter((e=>"apple"!=e.id&&t.includes(e.id))),t.includes("univerify")&&(this.univerifyStyle.privacyTerms.privacyItems=this.agreements,e.forEach((({id:e,logo:i,path:t})=>{"univerify"!=e&&this.univerifyStyle.buttons.list.push({iconPath:i,provider:e,path:t})}))),this.servicesList=e.filter((e=>(e.path?e.path.split("?")[0]:"")!=this.getRoute(1)))},methods:{getParentComponent(){return this.$parent},setUserInfo(e){console.log("setUserInfo",e)},getRoute(e=0){let i=getCurrentPages();return e>i.length?"":"/"+i[i.length-e].route},toPage(i,t=0){let n=["navigateTo","redirectTo"][t];if(this.getRoute(1)==i.split("?")[0]&&"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"==this.getRoute(1)){let t=i.split("?")[1].split("=")[1];e.index.$emit("uni-id-pages-setLoginType",t)}else this.getRoute(2)==i?e.index.navigateBack():this.getRoute(1)!=i?e.index[n]({url:i,animationType:"slide-in-left",complete(e){}}):console.log("出乎意料的情况,path："+i)},async login_before(t,n=!0,o={}){var s,r;if(console.log(t),["qq","xiaomi","sinaweibo","taobao","facebook","google","alipay","douyin"].includes(t))return e.index.showToast({title:"该登录方式暂未实现，欢迎提交pr",icon:"none",duration:3e3});if(["univerify","apple"].includes(t))return e.index.showToast({title:"当前设备不支持此登录，请选择其他登录方式",icon:"none",duration:3e3});let l=((null==(r=null==(s=i.config)?void 0:s.agreements)?void 0:r.scope)||[]).includes("register");if("univerify"!=t&&l&&!this.agree){return this.getParentComponent().$refs.agreements.popup((()=>{this.login_before(t,n,o)}))}if(e.index.showLoading({mask:!0}),"univerify"==t){let i=function(){e.index.hideLoading(),t.close(),t.offButtonsClick(o)},t=e.index.getUniverifyManager(),n=!1,o=async t=>{console.log("点击了第三方登录，provider：",t,t.provider,this.univerifyStyle.buttons.list),n=!0;let o=await e.index.getCheckBoxState();this.agree=o.state;let{path:s}=this.univerifyStyle.buttons.list[t.index];s?(this.getRoute(1).includes("login-withoutpwd")&&s.includes("login-withoutpwd")&&this.getParentComponent().showCurrentWebview(),this.toPage(s,1),i()):this.agree?(i(),setTimeout((()=>{this.login_before(t.provider)}),500)):e.index.showToast({title:"你未同意隐私政策协议",icon:"none",duration:3e3})};return t.onButtonsClick(o),t.login({univerifyStyle:this.univerifyStyle,success:e=>{this.login(e.authResult,"univerify")},fail(i){console.log(i),n||e.index.navigateBack()},complete:async i=>{e.index.hideLoading(),t.offButtonsClick(o)}})}if("weixinMobile"===t)return this.login({phoneCode:o.phoneNumberCode},t);e.index.login({provider:t,onlyAuthorize:!0,success:async i=>{if("apple"==t){let t=await this.getUserInfo({provider:"apple"});Object.assign(i.authResult,t.userInfo),e.index.hideLoading()}this.login("weixin"==t?{code:i.code}:i.authResult,t)},fail:async i=>{console.log(i),e.index.hideLoading()}})},login(i,n){console.log({params:i,type:n});let o="loginBy"+n.trim().replace(n[0],n[0].toUpperCase());e.Es.importObject("uni-id-co",{customUI:!0})[o](i).then((i=>{e.index.showToast({title:"登录成功",icon:"none",duration:2e3}),t.mutations.loginSuccess(i)})).catch((i=>{e.index.showModal({content:i.message,confirmText:"知道了",showCancel:!1})})).finally((i=>{"univerify"==n&&e.index.closeAuthView(),e.index.hideLoading()}))},getUserInfo:async i=>new Promise(((t,n)=>{e.index.getUserInfo({...i,success:e=>{t(e)},fail:i=>{e.index.showModal({content:JSON.stringify(i),showCancel:!1}),n(i)}})}))}};const o=e._export_sfc(n,[["render",function(i,t,n,o,s,r){return{a:e.f(s.servicesList,((i,t,n)=>({a:i.logo,b:e.t(i.text),c:t,d:e.o((e=>i.path?r.toPage(i.path):r.login_before(i.id,!1)),t)})))}}]]);wx.createComponent(o);
