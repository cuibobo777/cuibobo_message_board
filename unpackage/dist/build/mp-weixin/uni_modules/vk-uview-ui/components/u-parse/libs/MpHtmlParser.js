"use strict";const t=require("../../../../../common/vendor.js"),s=require("./config.js"),i=require("./CssHandler.js");var e=s.cfg.blankChar,a=t.index.getSystemInfoSync().windowWidth;function r(t,e={}){this.attrs={},this.CssHandler=new i.CssHandler(e.tagStyle),this.data=t,this.domain=e.domain,this.DOM=[],this.i=this.start=this.audioNum=this.imgNum=this.videoNum=0,e.prot=(this.domain||"").includes("://")?this.domain.split("://")[0]:"http",this.options=e,this.state=this.Text,this.STACK=[],this.bubble=()=>{for(var t,i=this.STACK.length;t=this.STACK[--i];){if(s.cfg.richOnlyTags[t.name])return!1;t.c=1}return!0},this.decode=(t,i)=>{for(var e,a,r=-1;-1!=(r=t.indexOf("&",r+1))&&-1!=(e=t.indexOf(";",r+2));)"#"==t[r+1]?(a=parseInt(("x"==t[r+2]?"0":"")+t.substring(r+2,e)),isNaN(a)||(t=t.substr(0,r)+String.fromCharCode(a)+t.substr(e+1))):(a=t.substring(r+1,e),(s.cfg.entities[a]||a==i)&&(t=t.substr(0,r)+(s.cfg.entities[a]||"&")+t.substr(e+1)));return t},this.getUrl=t=>("/"==t[0]?"/"==t[1]?t=this.options.prot+":"+t:this.domain&&(t=this.domain+t):this.domain&&0!=t.indexOf("data:")&&!t.includes("://")&&(t=this.domain+"/"+t),t),this.isClose=()=>">"==this.data[this.i]||"/"==this.data[this.i]&&">"==this.data[this.i+1],this.section=()=>this.data.substring(this.start,this.i),this.parent=()=>this.STACK[this.STACK.length-1],this.siblings=()=>this.STACK.length?this.parent().children:this.DOM}r.prototype.parse=function(){for(var t;t=this.data[this.i];this.i++)this.state(t);for(this.state==this.Text&&this.setText();this.STACK.length;)this.popNode(this.STACK.pop());return this.DOM},r.prototype.setAttr=function(){var t=this.attrName.toLowerCase(),i=this.attrVal;for(s.cfg.boolAttrs[t]?this.attrs[t]="T":i&&("src"==t||"data-src"==t&&!this.attrs.src?this.attrs.src=this.getUrl(this.decode(i,"amp")):"href"==t||"style"==t?this.attrs[t]=this.decode(i,"amp"):"data-"!=t.substr(0,5)&&(this.attrs[t]=i)),this.attrVal="";e[this.data[this.i]];)this.i++;this.isClose()?this.setNode():(this.start=this.i,this.state=this.AttrName)},r.prototype.setText=function(){var t=this.section();if(t){if(!this.pre){var s,i=[];for(let a,r=t.length;a=t[--r];)e[a]?(" "!=i[0]&&i.unshift(" "),"\n"==a&&null==s&&(s=0)):(i.unshift(a),s||(s=1));if(0==s)return;t=i.join("")}this.siblings().push({type:"text",text:this.decode(t)})}},r.prototype.setNode=function(){var t={name:this.tagName.toLowerCase(),attrs:this.attrs},i=s.cfg.selfClosingTags[t.name];if(this.options.nodes.length&&(t.type="node"),this.attrs={},s.cfg.ignoreTags[t.name])if(i)if("source"==t.name){var r=this.parent();r&&("video"==r.name||"audio"==r.name)&&t.attrs.src&&r.attrs.source.push(t.attrs.src)}else"base"!=t.name||this.domain||(this.domain=t.attrs.href);else this.remove(t);else{var h=t.attrs,n=this.CssHandler.match(t.name,h,t)+(h.style||""),o={};switch(h.id&&(1&this.options.compress?h.id=void 0:this.options.useAnchor&&this.bubble()),2&this.options.compress&&h.class&&(h.class=void 0),t.name){case"a":case"ad":this.bubble();break;case"font":if(h.color&&(o.color=h.color,h.color=void 0),h.face&&(o["font-family"]=h.face,h.face=void 0),h.size){var l=parseInt(h.size);l<1?l=1:l>7&&(l=7);o["font-size"]=["xx-small","x-small","small","medium","large","x-large","xx-large"][l-1],h.size=void 0}break;case"embed":var d=t.attrs.src||"",c=t.attrs.type||"";if(c.includes("video")||d.includes(".mp4")||d.includes(".3gp")||d.includes(".m3u8"))t.name="video";else{if(!(c.includes("audio")||d.includes(".m4a")||d.includes(".wav")||d.includes(".mp3")||d.includes(".aac")))break;t.name="audio"}t.attrs.autostart&&(t.attrs.autoplay="T"),t.attrs.controls="T";case"video":case"audio":h.id?this[`${t.name}Num`]++:h.id=t.name+ ++this[`${t.name}Num`],"video"==t.name&&(this.videoNum>3&&(t.lazyLoad=1),h.width&&(o.width=parseFloat(h.width)+(h.width.includes("%")?"%":"px"),h.width=void 0),h.height&&(o.height=parseFloat(h.height)+(h.height.includes("%")?"%":"px"),h.height=void 0)),h.controls||h.autoplay||(h.controls="T"),h.source=[],h.src&&(h.source.push(h.src),h.src=void 0),this.bubble();break;case"td":case"th":if(h.colspan||h.rowspan)for(var p,g=this.STACK.length;p=this.STACK[--g];)if("table"==p.name){p.flag=1;break}}h.align&&("table"==t.name?"center"==h.align?o["margin-inline-start"]=o["margin-inline-end"]="auto":o.float=h.align:o["text-align"]=h.align,h.align=void 0);var f,u=n.split(";");n="";for(var m=0,v=u.length;m<v;m++){var b=u[m].split(":");if(b.length<2)continue;let t=b[0].trim().toLowerCase(),s=b.slice(1).join(":").trim();"-"==s[0]||s.includes("safe")?n+=`;${t}:${s}`:o[t]&&!s.includes("import")&&o[t].includes("import")||(o[t]=s)}if("img"==t.name)h.src&&!h.ignore&&(this.bubble()?h.i=(this.imgNum++).toString():h.ignore="T"),h.ignore&&(n+=";-webkit-touch-callout:none",o["max-width"]="100%"),o.width?f=o.width:h.width&&(f=h.width.includes("%")?h.width:parseFloat(h.width)+"px"),f&&(o.width=f,h.width="100%",parseInt(f)>a&&(o.height="",h.height&&(h.height=void 0))),o.height?(h.height=o.height,o.height=""):h.height&&!h.height.includes("%")&&(h.height=parseFloat(h.height)+"px");for(var y in o){var x=o[y];if(x){if((y.includes("flex")||"order"==y||"self-align"==y)&&(t.c=1),x.includes("url")){var C=x.indexOf("(");if(-1!=C++){for(;'"'==x[C]||"'"==x[C]||e[x[C]];)C++;x=x.substr(0,C)+this.getUrl(x.substr(C))}}else x.includes("rpx")?x=x.replace(/[0-9.]+\s*rpx/g,(t=>parseFloat(t)*a/750+"px")):"white-space"==y&&x.includes("pre")&&!i&&(this.pre=t.pre=!0);n+=`;${y}:${x}`}}(n=n.substr(1))&&(h.style=n),i?this.siblings().push(t):(t.children=[],"pre"==t.name&&s.cfg.highlight&&(this.remove(t),this.pre=t.pre=!0),this.siblings().push(t),this.STACK.push(t))}"/"==this.data[this.i]&&this.i++,this.start=this.i+1,this.state=this.Text},r.prototype.remove=function(t){var i=t.name,a=this.i,r=()=>{var s=this.data.substring(a,this.i+1);for(var i in t.attrs.xmlns="http://www.w3.org/2000/svg",t.attrs)"viewbox"==i?s=` viewBox="${t.attrs.viewbox}"`+s:"style"!=i&&(s=` ${i}="${t.attrs[i]}"`+s);s="<svg"+s;var e=this.parent();"100%"==t.attrs.width&&e&&(e.attrs.style||"").includes("inline")&&(e.attrs.style="width:300px;max-width:100%;"+e.attrs.style),this.siblings().push({name:"img",attrs:{src:"data:image/svg+xml;utf8,"+s.replace(/#/g,"%23"),style:t.attrs.style,ignore:"T"}})};if("svg"==t.name&&"/"==this.data[a])return r(this.i++);for(;;){if(-1==(this.i=this.data.indexOf("</",this.i+1)))return void(this.i="pre"==i||"svg"==i?a:this.data.length);for(this.start=this.i+=2;!e[this.data[this.i]]&&!this.isClose();)this.i++;if(this.section().toLowerCase()==i)return"pre"==i?(this.data=this.data.substr(0,a+1)+s.cfg.highlight(this.data.substring(a+1,this.i-5),t.attrs)+this.data.substr(this.i-5),this.i=a):("style"==i?this.CssHandler.getStyle(this.data.substring(a+1,this.i-7)):"title"==i&&(this.DOM.title=this.data.substring(a+1,this.i-7)),-1==(this.i=this.data.indexOf(">",this.i))&&(this.i=this.data.length),void("svg"==i&&r()))}},r.prototype.popNode=function(t){if(t.pre){t.pre=this.pre=void 0;for(let t=this.STACK.length;t--;)this.STACK[t].pre&&(this.pre=!0)}var i=this.siblings(),e=i.length,a=t.children;if("head"==t.name||s.cfg.filter)return i.pop();var r=t.attrs;if(s.cfg.blockTags[t.name]?t.name="div":s.cfg.trustTags[t.name]||(t.name="span"),t.c&&("ul"==t.name||"ol"==t.name))if((t.attrs.style||"").includes("list-style:none"))for(let s,y=0;s=a[y++];)"li"==s.name&&(s.name="div");else if("ul"==t.name){var h=1;for(let t=this.STACK.length;t--;)"ul"==this.STACK[t].name&&h++;if(1!=h)for(let t=a.length;t--;)a[t].floor=h}else for(let s,y=0,x=1;s=a[y++];)"li"==s.name&&(s.type="ol",s.num=((t,s)=>{if("a"==s)return String.fromCharCode(97+(t-1)%26);if("A"==s)return String.fromCharCode(65+(t-1)%26);if("i"==s||"I"==s){t=(t-1)%99+1;var i=(["X","XX","XXX","XL","L","LX","LXX","LXXX","XC"][Math.floor(t/10)-1]||"")+(["I","II","III","IV","V","VI","VII","VIII","IX"][t%10-1]||"");return"i"==s?i.toLowerCase():i}return t})(x++,r.type)+".");if("table"==t.name){var n=parseFloat(r.cellpadding),o=parseFloat(r.cellspacing),l=parseFloat(r.border);if(t.c&&(isNaN(n)&&(n=2),isNaN(o)&&(o=2)),l&&(r.style=`border:${l}px solid gray;${r.style||""}`),t.flag&&t.c){r.style=`${r.style||""};${o?`;grid-gap:${o}px`:";border-left:0;border-top:0"}`;var d,c=1,p=1,g=[],f=[],u={};!function t(s){for(var i=0;i<s.length;i++)"tr"==s[i].name?g.push(s[i]):t(s[i].children||[])}(t.children);for(let t=0;t<g.length;t++){for(let s,i=0;s=g[t].children[i];i++)if("td"==s.name||"th"==s.name){for(;u[c+"."+p];)p++;var m={name:"div",c:1,attrs:{style:(s.attrs.style||"")+(l?`;border:${l}px solid gray`+(o?"":";border-right:0;border-bottom:0"):"")+(n?`;padding:${n}px`:"")},children:s.children};if(s.attrs.colspan&&(m.attrs.style+=";grid-column-start:"+p+";grid-column-end:"+(p+parseInt(s.attrs.colspan)),s.attrs.rowspan||(m.attrs.style+=";grid-row-start:"+c+";grid-row-end:"+(c+1)),p+=parseInt(s.attrs.colspan)-1),s.attrs.rowspan){m.attrs.style+=";grid-row-start:"+c+";grid-row-end:"+(c+parseInt(s.attrs.rowspan)),s.attrs.colspan||(m.attrs.style+=";grid-column-start:"+p+";grid-column-end:"+(p+1));for(var v=1;v<s.attrs.rowspan;v++)u[c+v+"."+p]=1}f.push(m),p++}d||(d=p-1,r.style+=`;grid-template-columns:repeat(${d},auto)`),p=1,c++}t.children=f}else r.style=`border-spacing:${o}px;${r.style||""}`,(l||n)&&function t(s){for(var i,e=0;i=s[e];e++)"th"==i.name||"td"==i.name?(l&&(i.attrs.style=`border:${l}px solid gray;${i.attrs.style||""}`),n&&(i.attrs.style=`padding:${n}px;${i.attrs.style||""}`)):t(i.children||[])}(a);if(this.options.autoscroll){var b=Object.assign({},t);t.name="div",t.attrs={style:"overflow:scroll"},t.children=[b]}}this.CssHandler.pop&&this.CssHandler.pop(t),"div"!=t.name||Object.keys(r).length||1!=a.length||"div"!=a[0].name||(i[e-1]=a[0])},r.prototype.Text=function(t){if("<"==t){var s=this.data[this.i+1],i=t=>t>="a"&&t<="z"||t>="A"&&t<="Z";i(s)?(this.setText(),this.start=this.i+1,this.state=this.TagName):"/"==s?(this.setText(),i(this.data[1+ ++this.i])?(this.start=this.i+1,this.state=this.EndTag):this.Comment()):"!"!=s&&"?"!=s||(this.setText(),this.Comment())}},r.prototype.Comment=function(){var t;t="--"==this.data.substring(this.i+2,this.i+4)?"--\x3e":"[CDATA["==this.data.substring(this.i+2,this.i+9)?"]]>":">",-1==(this.i=this.data.indexOf(t,this.i+2))?this.i=this.data.length:this.i+=t.length-1,this.start=this.i+1,this.state=this.Text},r.prototype.TagName=function(t){if(e[t]){for(this.tagName=this.section();e[this.data[this.i]];)this.i++;this.isClose()?this.setNode():(this.start=this.i,this.state=this.AttrName)}else this.isClose()&&(this.tagName=this.section(),this.setNode())},r.prototype.AttrName=function(t){if("="==t||e[t]||this.isClose()){if(this.attrName=this.section(),e[t])for(;e[this.data[++this.i]];);if("="==this.data[this.i]){for(;e[this.data[++this.i]];);this.start=this.i--,this.state=this.AttrValue}else this.setAttr()}},r.prototype.AttrValue=function(t){if('"'==t||"'"==t){if(this.start++,-1==(this.i=this.data.indexOf(t,this.i+1)))return this.i=this.data.length;this.attrVal=this.section(),this.i++}else{for(;!e[this.data[this.i]]&&!this.isClose();this.i++);this.attrVal=this.section()}this.setAttr()},r.prototype.EndTag=function(t){if(e[t]||">"==t||"/"==t){for(var s=this.section().toLowerCase(),i=this.STACK.length;i--&&this.STACK[i].name!=s;);if(-1!=i){for(var a;(a=this.STACK.pop()).name!=s;)this.popNode(a);this.popNode(a)}else"p"!=s&&"br"!=s||this.siblings().push({name:s,attrs:{}});this.i=this.data.indexOf(">",this.i),this.start=this.i+1,-1==this.i?this.i=this.data.length:this.state=this.Text}},exports.MpHtmlParser=r;
