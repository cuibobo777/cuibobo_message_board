"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/tools.js"),o=require("../../uni_modules/uni-id-pages/common/store.js");if(require("../../uni_modules/uni-id-pages/config.js"),!Array){(e.resolveComponent("uni-dateformat")+e.resolveComponent("u-parse")+e.resolveComponent("u-empty")+e.resolveComponent("comment-item")+e.resolveComponent("uni-load-more")+e.resolveComponent("comment-frame"))()}Math||((()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-parse/u-parse.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-empty/u-empty.js")+(()=>"../../components/comment-item/comment-item.js")+(()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js")+(()=>"../../components/comment-frame/comment-frame.js"))();const n={__name:"detail",setup(n){const i=e.Es.database(),a=e.Es.importObject("utilsObject",{customUI:!0}),l=e.ref("");e.ref("");const r=e.ref(0),u=e.ref(!0),s=e.reactive({article_id:"",comment_type:0});let d={};const c=e.reactive([]),m=e.reactive([]),_=e.ref(!1),p=e.ref("more"),v=e.ref(!1);e.onLoad((e=>{e.id?(l.value=e.id,s.article_id=e.id,y(),w(),c.length=0,j(),p.value="loading",f(),p.value="more"):k()}));const f=async()=>{let e=i.collection("board_comment").where(`article_id == '${l.value}' && \n\tcomment_type == 0`).orderBy("comment_date desc").skip(m.length).limit(5).getTemp(),t=i.collection("uni-id-users").field("_id,nickname,username,avatar_file").getTemp(),o=await i.collection(e,t).get(),n=o.result.data.map((e=>e._id)),a=await i.collection("board_comment").where({reply_comment_id:i.command.in(n)}).groupBy("reply_comment_id").groupField("count(*) as totalReply").get();o.result.data.forEach((e=>{let t=a.result.data.findIndex((t=>t.reply_comment_id==e._id));t>-1&&(e.totalReply=a.result.data[t].totalReply)})),0==o.result.data.length&&(v.value=!0,p.value="noMore",_.value=!0),m.push(...o.result.data)};e.onReachBottom((()=>{p.value="loading",v.value?p.value="noMore":f()}));const g=e=>{m.unshift({...e,...s,user_id:[o.store.userInfo],comment_date:Date.now()})},h=e=>{let t=m.findIndex((t=>t._id==e));m.splice(t,1)},k=()=>{e.index.showToast({title:"参数有误",icon:"none"}),setTimeout((()=>{e.index.reLaunch({url:"/pages/index/index"})}),1e3)},y=()=>{let t=i.collection("board_article").where(`_id == '${l.value}'`).getTemp(),n=i.collection("uni-id-users").field("_id,nickname,username,avatar_file").getTemp(),a=i.collection("board_like").where(`article_id=="${l.value}" && user_id==$cloudEnv_uid`).getTemp(),r=[t,n];o.store.hasLogin&&r.push(a),i.collection(...r).get({getOne:!0}).then((t=>{var n,i;if(!t.result.data)return void k();let a=!1;o.store.hasLogin&&(a=!!(null==(i=null==(n=t.result.data._id)?void 0:n.board_like)?void 0:i.length)),t.result.data.isLike=a,d=e.reactive(t.result.data),u.value=!1})).catch((e=>{k()}))},w=()=>{a.operation("board_article","view_count",l.value,1).then((e=>{}))},b=()=>{o.store.hasLogin||e.index.showModal({title:"是否前往登录",success:t=>{var o;t.confirm&&e.index.navigateTo({url:"/"+(null==(o=e.pageJson.uniIdRouter)?void 0:o.loginPage)})}});let n=Date.now();n-r.value<2e3?e.index.showToast({title:"操作太频繁，请稍后...",icon:"none"}):(d.isLike?d.like_count--:d.like_count++,d.isLike=!d.isLike,r.value=n,t.likeFun(l.value))},j=()=>{let e=i.collection("board_like").where(`article_id == '${l.value}'`).getTemp(),t=i.collection("uni-id-users").field("_id, avatar_file").getTemp();i.collection(e,t).orderBy("publish_date desc").limit(5).get().then((e=>{e.result.data=e.result.data.reverse(),c.push(...e.result.data)}))};return(o,n)=>e.e({a:u.value},u.value?{}:e.e({b:e.t(e.unref(d).title),c:e.unref(t.getAvatar)(e.unref(d)),d:e.t(e.unref(t.getName)(e.unref(d))),e:e.p({date:e.unref(d).publish_date,format:"yyyy年MM月dd hh:mm:ss"}),f:e.t(e.unref(d).province),g:e.p({html:e.unref(d).content}),h:e.unref(d).like_count},e.unref(d).like_count?{i:e.t(e.unref(d).like_count)}:{},{j:e.n(e.unref(d).isLike?"active":""),k:e.o(b),l:e.f(c,((o,n,i)=>e.e({a:o.user_id[0].avatar_file},o.user_id[0].avatar_file?{b:e.unref(t.getAvatar)(o)}:{},{c:n}))),m:e.t(e.unref(d).view_count)}),{n:!m.length&&_.value},!m.length&&_.value?{o:e.p({text:"没有人在这里留言",mode:"message"})}:{p:e.f(m,((t,o,n)=>({a:e.o(h,t._id),b:"1e2ef38f-3-"+n,c:e.p({item:t}),d:t._id})))},{q:e.p({color:"#0f505e",status:p.value}),r:e.o(g),s:e.p({comment:s})})}},i=e._export_sfc(n,[["__scopeId","data-v-1e2ef38f"]]);wx.createPage(i);
